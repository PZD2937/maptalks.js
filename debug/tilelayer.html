<html>
<head>
    <meta charset="UTF-8"/>
    <script type="text/javascript" src="../dist/maptalks.js"></script>
    <script type="text/javascript" src="https://fuzhenn.github.io/chinese_coordinate_conversion/chncrs.js"></script>
    <title>TileLayer Tests</title>
    <style>
        html,
        body {
            margin: 0px;
            height: 100%;
            width: 100%;
        }

        .map {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<div id="map" class="map"></div>
<script>
    var center = [116.39158881629862, 39.90739423892174];

    function placeholder(canvas) {
        const ctx = canvas.getContext('2d'), cw = canvas.width, ch = canvas.height, w = cw / 16, h = ch / 16;
        ctx.beginPath();
        for (let i = 0; i < 16; i++) {
            ctx.moveTo(0, i * h);
            ctx.lineTo(cw, i * h);
            ctx.moveTo(i * w, 0);
            ctx.lineTo(i * w, ch);
        }
        ctx.strokeStyle = 'rgba(50,50,50,0.4)';
        ctx.lineWidth = 0.5;
        ctx.stroke();
        ctx.beginPath();
        const path = [
            [0, 0], [cw, 0], [0, ch], [cw, ch], [0, 0], [0, ch], [cw, 0], [cw, ch], [0, ch / 2], [cw, ch / 2], [cw / 2, 0], [cw / 2, ch]
        ];
        for (let i = 1; i < path.length; i += 2) {
            ctx.moveTo(path[i - 1][0], path[i - 1][1]);
            ctx.lineTo(path[i][0], path[i][1]);
        }
        ctx.lineWidth = 1;
        ctx.stroke();
    }

    function createBaseLayer() {
        return new maptalks.GroupTileLayer('BaseTileLayer',
            [new maptalks.TileLayer('base', {
                'urlTemplate': 'https://tiles{s}.geovisearth.com/base/v1/img/{z}/{x}/{y}?format=webp&token=4ad5e04ac2f2ad002f4e99c9a87886a0088a9efd108598a6738e45cd22a5582e',
                'subdomains': [1, 2, 3],
                offset: function (z) {
                    const map = this.getMap();
                    //实时计算wgs84和gcj02瓦片的偏移量
                    const center = map.getCenter();
                    const c = maptalks.CRSTransform.transform(center.toArray(), 'WGS84', 'GCJ02');
                    const offset = map.coordToPoint(center, z).sub(map.coordToPoint(new maptalks.Coordinate(c), z));
                    return offset._round().toArray();
                },
                cascadeTiles: false,
                decodeImageInWorker: true,
                debug: true
            })],
            {
                background: false,
                repeatWorld: false,
                fadeAnimation: true,           //fade animation when loading tiles
                cascadeTiles: false,             //draw cascaded tiles of different zooms to reduce tiles
                hitDetect: false,
                geometryEvents: false,
                forceRenderOnMoving: true,
                forceRenderOnZooming: false,
                forceRenderOnRotating: false,
                placeholder: placeholder,           //a placeholder image to replace loading tile, can be a function with a parameter of the tile canvas
                tileRetryCount: 2,                  //retry count of tiles
                crossOrigin: 'anonymous',
                decodeImageInWorker: true,
                stopRenderOnOffscreen: true,
                debug: true
            })
    }

    new maptalks.Map('map', {
        center: center,
        zoom: 15.911386200274428,
        centerCross: true,
        baseLayer: createBaseLayer(),
        layers: [
            new maptalks.VectorLayer('v', new maptalks.Marker(center))
        ],
    })

</script>
</body>
</html>
